<?php
/**
 * @file
 * Adds federal google analytics js to every page load via
 * a select list populated with the .js files in the module's js directory
 */


/**
 * Implements hook_init().
 */
  function usfedgov_google_analytics_init(){

    usfedgov_google_analytics_gen_array();
    $js_selection = variable_get('usfedgov_google_analytics_js_selection');
    drupal_add_js(drupal_get_path('module', 'usfedgov_google_analytics').'/js/'.$js_selection);
  }

/**
 * Implements hook_menu().
 */
  function usfedgov_google_analytics_menu() {
  $items = array();

  $items['admin/config/system/usfedgov_google_analytics'] = array(
    'title' => 'Federal Google Analytics',
    'description' => 'Configuration for federal google analytics module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('usfedgov_google_analytics_form'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Page callback: Federal Google Analytics settings
 *
 * @see usfedgov_google_analytics_menu()
 */

function usfedgov_google_analytics_form($form, &$form_state) {

  $full_list =array();
  $full_list =  variable_get('js_options','');
  print_r($full_list);



// Select field for js file selection
$form['usfedgov_google_analytics_js_selection'] = array(
 '#type' => 'select',
 '#default_value' => variable_get('usfedgov_google_analytics_js_selection',
                                   ''),
       '#title' => t('Federal Google Analytics JS File Selection'),
       '#options' => $full_list,
       '#description' => t('Select the google analytics js file that should be included on this site.'),
   );




// Submit button
$form['submit'] = array(
'#type' => 'submit',
'#value' => t('Save settings'),
);

return $form;
}


/**
 * Save configuration settings for federal google analytics module.
 */
 function usfedgov_google_analytics_form_submit($form, &$form_state) {
 variable_set('usfedgov_google_analytics_js_selection',
            $form_state['values']['usfedgov_google_analytics_js_selection']);

 drupal_set_message(t('The settings have been saved'));



}

function usfedgov_google_analytics_gen_array() {
  $directory=  "sites/all/modules/usfedgov_google_analytics/js";

  //$directory= drupal_get_path('module', 'usfedgov_google_analytics'.'/js');
  //print($directory);

   // create a handler to the directory
    $dirhandler = opendir($directory);

    // read all the files from directory
    $nofiles=0;
    while ($file = readdir($dirhandler)) {

        // if $file isn't this directory or its parent
        //add to the $files array
        if ($file != '.' && $file != '..' && (substr($file, -3) == '.js'))
        {
      $nofiles++;
      $files[$nofiles]=$file;
        }
    }
//make the array associative with map assoc so the select list value
//is the file name and not the array index
$js_options = array();
$js_options = drupal_map_assoc($files);
variable_set('js_options', $js_options);

    //close the handler
    closedir($dirhandler);
}

